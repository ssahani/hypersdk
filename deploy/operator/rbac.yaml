---
# ServiceAccount for the operator
apiVersion: v1
kind: ServiceAccount
metadata:
  name: hypersdk-operator
  namespace: hypersdk-system
  labels:
    app: hypersdk-operator
    app.kubernetes.io/name: hypersdk-operator
    app.kubernetes.io/component: operator

---
# ClusterRole with permissions for HyperSDK CRDs and resources
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: hypersdk-operator
  labels:
    app: hypersdk-operator
    app.kubernetes.io/name: hypersdk-operator
    app.kubernetes.io/component: operator
rules:
  # BackupJob permissions
  - apiGroups:
      - hypersdk.io
    resources:
      - backupjobs
    verbs:
      - create
      - delete
      - get
      - list
      - patch
      - update
      - watch
  - apiGroups:
      - hypersdk.io
    resources:
      - backupjobs/status
    verbs:
      - get
      - patch
      - update
  - apiGroups:
      - hypersdk.io
    resources:
      - backupjobs/finalizers
    verbs:
      - update

  # BackupSchedule permissions
  - apiGroups:
      - hypersdk.io
    resources:
      - backupschedules
    verbs:
      - create
      - delete
      - get
      - list
      - patch
      - update
      - watch
  - apiGroups:
      - hypersdk.io
    resources:
      - backupschedules/status
    verbs:
      - get
      - patch
      - update
  - apiGroups:
      - hypersdk.io
    resources:
      - backupschedules/finalizers
    verbs:
      - update

  # RestoreJob permissions
  - apiGroups:
      - hypersdk.io
    resources:
      - restorejobs
    verbs:
      - create
      - delete
      - get
      - list
      - patch
      - update
      - watch
  - apiGroups:
      - hypersdk.io
    resources:
      - restorejobs/status
    verbs:
      - get
      - patch
      - update
  - apiGroups:
      - hypersdk.io
    resources:
      - restorejobs/finalizers
    verbs:
      - update

  # KubeVirt permissions (for KubeVirt provider)
  - apiGroups:
      - kubevirt.io
    resources:
      - virtualmachines
      - virtualmachineinstances
    verbs:
      - get
      - list
      - watch
  - apiGroups:
      - snapshot.kubevirt.io
    resources:
      - virtualmachinesnapshots
      - virtualmachinerestores
      - virtualmachineexports
    verbs:
      - create
      - delete
      - get
      - list
      - patch
      - update
      - watch

  # Secret permissions (for credentials)
  - apiGroups:
      - ""
    resources:
      - secrets
    verbs:
      - get
      - list
      - watch

  # ConfigMap permissions
  - apiGroups:
      - ""
    resources:
      - configmaps
    verbs:
      - get
      - list
      - watch

  # Event permissions
  - apiGroups:
      - ""
    resources:
      - events
    verbs:
      - create
      - patch
      - update

  # Pod permissions (for job execution)
  - apiGroups:
      - ""
    resources:
      - pods
    verbs:
      - create
      - delete
      - get
      - list
      - watch

  # PersistentVolumeClaim permissions
  - apiGroups:
      - ""
    resources:
      - persistentvolumeclaims
    verbs:
      - get
      - list
      - watch

  # Lease permissions (for leader election)
  - apiGroups:
      - coordination.k8s.io
    resources:
      - leases
    verbs:
      - create
      - get
      - list
      - update

---
# ClusterRoleBinding to bind the ClusterRole to the ServiceAccount
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: hypersdk-operator
  labels:
    app: hypersdk-operator
    app.kubernetes.io/name: hypersdk-operator
    app.kubernetes.io/component: operator
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: hypersdk-operator
subjects:
  - kind: ServiceAccount
    name: hypersdk-operator
    namespace: hypersdk-system
