<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HyperSDK - Charts & Analytics</title>
    <link rel="stylesheet" href="/static/css/main.css">
    <link rel="stylesheet" href="/static/css/k8s.css">
    <style>
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: #1e293b;
            border-radius: 12px;
            border: 1px solid #334155;
            padding: 20px;
            min-height: 350px;
        }

        .chart-card h3 {
            color: #f97316;
            margin-bottom: 20px;
            font-size: 1.125rem;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .chart-header h3 {
            margin: 0;
        }

        .download-chart-btn {
            padding: 6px 12px;
            background: rgba(249, 115, 22, 0.2);
            border: 1px solid #f97316;
            border-radius: 6px;
            color: #f97316;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .download-chart-btn:hover {
            background: rgba(249, 115, 22, 0.3);
            transform: translateY(-1px);
        }

        .chart-canvas {
            width: 100%;
            height: 300px;
            border-radius: 8px;
        }

        .chart-full-width {
            grid-column: 1 / -1;
        }

        .stats-summary {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            padding: 30px;
            border-radius: 12px;
            border: 1px solid #334155;
            margin-bottom: 30px;
        }

        .stats-summary h3 {
            color: #f97316;
            margin-bottom: 20px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .summary-item {
            text-align: center;
        }

        .summary-value {
            font-size: 2rem;
            font-weight: bold;
            color: #f97316;
            margin-bottom: 5px;
        }

        .summary-label {
            font-size: 0.875rem;
            color: #94a3b8;
        }

        .connection-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
            background: rgba(100, 116, 139, 0.2);
            color: #94a3b8;
            margin-left: 10px;
        }

        .connection-status.connected {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }

        .connection-status .indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1>üìä Charts & Analytics</h1>
                    <p>Backup Trends, Carbon Savings & Performance Metrics</p>
                </div>
                <div class="connection-status" id="ws-status">
                    <span class="indicator"></span>
                    <span>Connecting...</span>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Back Link -->
        <div style="margin-bottom: 20px;">
            <a href="/k8s" style="color: #f97316; text-decoration: none;">‚Üê Back to Dashboard</a>
        </div>

        <!-- Statistics Summary -->
        <div class="stats-summary">
            <h3>Summary Statistics</h3>
            <div class="summary-grid">
                <div class="summary-item">
                    <div class="summary-value" id="total-backups-chart">0</div>
                    <div class="summary-label">Total Backups</div>
                </div>
                <div class="summary-item">
                    <div class="summary-value" id="total-size-chart">0 GB</div>
                    <div class="summary-label">Total Size</div>
                </div>
                <div class="summary-item">
                    <div class="summary-value" id="success-rate-chart">0%</div>
                    <div class="summary-label">Success Rate</div>
                </div>
                <div class="summary-item">
                    <div class="summary-value" id="carbon-saved-chart">0 kg</div>
                    <div class="summary-label">CO‚ÇÇ Saved</div>
                </div>
            </div>
        </div>

        <!-- Charts Grid -->
        <div class="charts-grid">
            <!-- Backup Trend Chart -->
            <div class="chart-card chart-full-width">
                <div class="chart-header">
                    <h3>Backup Success Rate (Last 30 Days)</h3>
                    <button class="download-chart-btn" onclick="downloadChart('backup-trend-chart', 'backup-success-rate')">üì• Download PNG</button>
                </div>
                <canvas id="backup-trend-chart" class="chart-canvas"></canvas>
            </div>

            <!-- Provider Distribution -->
            <div class="chart-card">
                <div class="chart-header">
                    <h3>Backups by Provider</h3>
                    <button class="download-chart-btn" onclick="downloadChart('provider-distribution-chart', 'backups-by-provider')">üì• Download PNG</button>
                </div>
                <canvas id="provider-distribution-chart" class="chart-canvas"></canvas>
            </div>

            <!-- Destination Distribution -->
            <div class="chart-card">
                <div class="chart-header">
                    <h3>Backups by Destination</h3>
                    <button class="download-chart-btn" onclick="downloadChart('destination-distribution-chart', 'backups-by-destination')">üì• Download PNG</button>
                </div>
                <canvas id="destination-distribution-chart" class="chart-canvas"></canvas>
            </div>

            <!-- Carbon Intensity Trend -->
            <div class="chart-card chart-full-width">
                <div class="chart-header">
                    <h3>Carbon Intensity Over Time (gCO‚ÇÇ/kWh)</h3>
                    <button class="download-chart-btn" onclick="downloadChart('carbon-trend-chart', 'carbon-intensity-trend')">üì• Download PNG</button>
                </div>
                <canvas id="carbon-trend-chart" class="chart-canvas"></canvas>
            </div>

            <!-- Storage Usage -->
            <div class="chart-card">
                <div class="chart-header">
                    <h3>Storage by Destination</h3>
                    <button class="download-chart-btn" onclick="downloadChart('storage-distribution-chart', 'storage-by-destination')">üì• Download PNG</button>
                </div>
                <canvas id="storage-distribution-chart" class="chart-canvas"></canvas>
            </div>

            <!-- Backup Size Trend -->
            <div class="chart-card">
                <div class="chart-header">
                    <h3>Average Backup Size (GB)</h3>
                    <button class="download-chart-btn" onclick="downloadChart('size-trend-chart', 'backup-size-trend')">üì• Download PNG</button>
                </div>
                <canvas id="size-trend-chart" class="chart-canvas"></canvas>
            </div>
        </div>

        <!-- VM Charts Section -->
        <div class="stats-summary">
            <h3>Virtual Machine Metrics</h3>
            <div class="summary-grid" id="vm-summary">
                <div class="summary-item">
                    <div class="summary-value" id="vm-total">0</div>
                    <div class="summary-label">Total VMs</div>
                </div>
                <div class="summary-item">
                    <div class="summary-value" id="vm-running">0</div>
                    <div class="summary-label">Running</div>
                </div>
                <div class="summary-item">
                    <div class="summary-value" id="vm-total-cpus">0</div>
                    <div class="summary-label">Total vCPUs</div>
                </div>
                <div class="summary-item">
                    <div class="summary-value" id="vm-total-memory">0</div>
                    <div class="summary-label">Memory (Gi)</div>
                </div>
                <div class="summary-item">
                    <div class="summary-value" id="vm-carbon-aware">0</div>
                    <div class="summary-label">Carbon-Aware VMs</div>
                </div>
            </div>
        </div>

        <div class="charts-grid">
            <!-- VM Trend Chart -->
            <div class="chart-card chart-full-width">
                <div class="chart-header">
                    <h3>VM Count Trend (24h)</h3>
                    <button class="download-chart-btn" onclick="downloadChart('vm-trend-chart', 'vm-trend')">üì• Download PNG</button>
                </div>
                <canvas id="vm-trend-chart" class="chart-canvas"></canvas>
            </div>

            <!-- VM Status Distribution -->
            <div class="chart-card">
                <div class="chart-header">
                    <h3>VM Status Distribution</h3>
                    <button class="download-chart-btn" onclick="downloadChart('vm-status-chart', 'vm-status')">üì• Download PNG</button>
                </div>
                <canvas id="vm-status-chart" class="chart-canvas"></canvas>
            </div>

            <!-- VM by Node Chart -->
            <div class="chart-card">
                <div class="chart-header">
                    <h3>VMs by Node</h3>
                    <button class="download-chart-btn" onclick="downloadChart('vm-node-chart', 'vm-by-node')">üì• Download PNG</button>
                </div>
                <canvas id="vm-node-chart" class="chart-canvas"></canvas>
            </div>

            <!-- Resource Utilization -->
            <div class="chart-card chart-full-width">
                <div class="chart-header">
                    <h3>VM Resource Allocation Trend</h3>
                    <button class="download-chart-btn" onclick="downloadChart('vm-resource-chart', 'vm-resources')">üì• Download PNG</button>
                </div>
                <canvas id="vm-resource-chart" class="chart-canvas"></canvas>
            </div>

            <!-- Carbon Intensity for VMs -->
            <div class="chart-card">
                <div class="chart-header">
                    <h3>Average Carbon Intensity (gCO‚ÇÇ/kWh)</h3>
                    <button class="download-chart-btn" onclick="downloadChart('vm-carbon-chart', 'vm-carbon')">üì• Download PNG</button>
                </div>
                <canvas id="vm-carbon-chart" class="chart-canvas"></canvas>
            </div>

            <!-- VM Size Distribution -->
            <div class="chart-card">
                <div class="chart-header">
                    <h3>VM Size Distribution</h3>
                    <button class="download-chart-btn" onclick="downloadChart('vm-size-chart', 'vm-size')">üì• Download PNG</button>
                </div>
                <canvas id="vm-size-chart" class="chart-canvas"></canvas>
            </div>
        </div>

        <div class="timestamp" id="last-update">Last updated: Never</div>
    </div>

    <script src="/static/js/charts.js"></script>
    <script>
        // Initialize charts
        let backupTrendChart, providerChart, destinationChart, carbonTrendChart, storageChart, sizeTrendChart;
        let vmTrendChart, vmStatusChart, vmNodeChart, vmResourceChart, vmCarbonChart, vmSizeChart;
        let ws = null;
        let wsReconnectInterval = null;

        document.addEventListener('DOMContentLoaded', () => {
            // Create backup chart instances
            backupTrendChart = new LineChart('backup-trend-chart', {
                title: '',
                yLabel: 'Backups',
                lineColor: '#10b981',
                fillColor: 'rgba(16, 185, 129, 0.1)',
            });

            providerChart = new DoughnutChart('provider-distribution-chart', {
                colors: ['#f97316', '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6']
            });

            destinationChart = new DoughnutChart('destination-distribution-chart', {
                colors: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6']
            });

            carbonTrendChart = new LineChart('carbon-trend-chart', {
                title: '',
                yLabel: 'gCO‚ÇÇ/kWh',
                lineColor: '#10b981',
                fillColor: 'rgba(16, 185, 129, 0.1)',
            });

            storageChart = new BarChart('storage-distribution-chart', {
                barColor: '#3b82f6'
            });

            sizeTrendChart = new LineChart('size-trend-chart', {
                title: '',
                yLabel: 'GB',
                lineColor: '#f97316',
                fillColor: 'rgba(249, 115, 22, 0.1)',
            });

            // Create VM chart instances
            vmTrendChart = new LineChart('vm-trend-chart', {
                title: '',
                yLabel: 'VMs',
                lineColor: '#3b82f6',
                fillColor: 'rgba(59, 130, 246, 0.1)',
            });

            vmStatusChart = new DoughnutChart('vm-status-chart', {
                colors: ['#10b981', '#6b7280', '#f59e0b', '#ef4444', '#3b82f6']
            });

            vmNodeChart = new BarChart('vm-node-chart', {
                barColor: '#f97316',
                yLabel: 'VMs'
            });

            vmResourceChart = new LineChart('vm-resource-chart', {
                title: '',
                yLabel: 'Resources',
                lineColor: '#8b5cf6',
                fillColor: 'rgba(139, 92, 246, 0.1)',
            });

            vmCarbonChart = new LineChart('vm-carbon-chart', {
                title: '',
                yLabel: 'gCO‚ÇÇ/kWh',
                lineColor: '#10b981',
                fillColor: 'rgba(16, 185, 129, 0.1)',
            });

            vmSizeChart = new DoughnutChart('vm-size-chart', {
                colors: ['#10b981', '#f59e0b', '#ef4444']
            });

            // Initial data load
            fetchAndUpdateCharts();

            // Connect to WebSocket for real-time updates
            connectWebSocket();

            // Fallback: Update every 30 seconds if WebSocket fails
            setInterval(() => {
                if (!ws || ws.readyState !== WebSocket.OPEN) {
                    fetchAndUpdateCharts();
                }
            }, 30000);
        });

        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/api/k8s/ws`;

            try {
                ws = new WebSocket(wsUrl);

                ws.onopen = () => {
                    console.log('WebSocket connected for charts');
                    updateConnectionStatus(true);
                    if (wsReconnectInterval) {
                        clearInterval(wsReconnectInterval);
                        wsReconnectInterval = null;
                    }
                };

                ws.onmessage = (event) => {
                    try {
                        const metrics = JSON.parse(event.data);
                        updateSummaryStats(metrics);
                        updateBackupTrendChart(metrics);
                        updateProviderChart(metrics);
                        updateDestinationChart(metrics);
                        updateCarbonTrendChart(metrics);
                        updateStorageChart(metrics);
                        updateSizeTrendChart(metrics);
                        updateLastUpdateTime();
                    } catch (error) {
                        console.error('Failed to parse WebSocket message:', error);
                    }
                };

                ws.onerror = (error) => {
                    console.error('WebSocket error:', error);
                };

                ws.onclose = () => {
                    console.log('WebSocket disconnected, attempting to reconnect...');
                    updateConnectionStatus(false);
                    // Attempt to reconnect after 5 seconds
                    if (!wsReconnectInterval) {
                        wsReconnectInterval = setInterval(() => {
                            console.log('Reconnecting WebSocket...');
                            connectWebSocket();
                        }, 5000);
                    }
                };
            } catch (error) {
                console.error('Failed to create WebSocket:', error);
            }
        }

        function updateConnectionStatus(connected) {
            const statusEl = document.getElementById('ws-status');
            if (!statusEl) return;

            if (connected) {
                statusEl.className = 'connection-status connected';
                statusEl.querySelector('span:last-child').textContent = 'Live Updates';
            } else {
                statusEl.className = 'connection-status';
                statusEl.querySelector('span:last-child').textContent = 'Reconnecting...';
            }
        }

        async function fetchAndUpdateCharts() {
            try {
                const response = await fetch('/api/k8s/metrics');
                const metrics = await response.json();

                updateSummaryStats(metrics);
                updateBackupTrendChart(metrics);
                updateProviderChart(metrics);
                updateDestinationChart(metrics);
                updateCarbonTrendChart(metrics);
                updateStorageChart(metrics);
                updateSizeTrendChart(metrics);

                // Update VM charts
                updateVMSummaryStats(metrics);
                updateVMTrendChart(metrics);
                updateVMStatusChart(metrics);
                updateVMNodeChart(metrics);
                updateVMResourceChart(metrics);
                updateVMCarbonChart(metrics);
                updateVMSizeChart(metrics);

                updateLastUpdateTime();
            } catch (error) {
                console.error('Failed to fetch chart data:', error);
            }
        }

        function updateSummaryStats(metrics) {
            const totalBackups = metrics.backup_jobs.total || 0;
            const completed = metrics.backup_jobs.completed || 0;
            const failed = metrics.backup_jobs.failed || 0;
            const successRate = totalBackups > 0 ? ((completed / totalBackups) * 100) : 0;

            document.getElementById('total-backups-chart').textContent = totalBackups;

            const totalSize = metrics.storage_stats.total_backup_size || 0;
            document.getElementById('total-size-chart').textContent = formatBytesShort(totalSize);

            document.getElementById('success-rate-chart').textContent = successRate.toFixed(1) + '%';

            const carbonSaved = metrics.carbon_stats.estimated_savings_kg || 0;
            document.getElementById('carbon-saved-chart').textContent = carbonSaved.toFixed(2) + ' kg';
        }

        function updateBackupTrendChart(metrics) {
            // Generate last 30 days data
            const data = [];
            const today = new Date();

            for (let i = 29; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const label = (i === 0) ? 'Today' : (i === 1) ? 'Yesterday' : date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

                // Simulate data based on current metrics (in real implementation, fetch historical data)
                const value = i < 7 ? Math.floor(Math.random() * 10) + 5 : Math.floor(Math.random() * 5) + 2;

                data.push({ label, value });
            }

            backupTrendChart.setData(data);
        }

        function updateProviderChart(metrics) {
            const providerStats = metrics.backup_jobs.by_provider || {};
            const data = Object.entries(providerStats).map(([label, value]) => ({
                label: label.charAt(0).toUpperCase() + label.slice(1),
                value
            }));

            if (data.length === 0) {
                data.push({ label: 'No data', value: 1 });
            }

            providerChart.setData(data);
        }

        function updateDestinationChart(metrics) {
            const destStats = metrics.storage_stats.backups_by_dest || {};
            const data = Object.entries(destStats).map(([label, value]) => {
                const destType = label.split('://')[0];
                return {
                    label: destType.toUpperCase(),
                    value
                };
            });

            if (data.length === 0) {
                data.push({ label: 'No data', value: 1 });
            }

            destinationChart.setData(data);
        }

        function updateCarbonTrendChart(metrics) {
            // Generate carbon intensity trend for last 30 days
            const data = [];
            const today = new Date();

            // Simulate trend (in real implementation, fetch historical data)
            const baseIntensity = metrics.carbon_stats.avg_intensity || 150;

            for (let i = 29; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const label = (i === 0) ? 'Today' : (i === 1) ? 'Yesterday' : date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

                // Simulate variation
                const value = baseIntensity + (Math.random() * 100 - 50);

                data.push({ label, value: Math.max(50, Math.round(value)) });
            }

            carbonTrendChart.setData(data);
        }

        function updateStorageChart(metrics) {
            const sizeByDest = metrics.storage_stats.size_by_dest || {};
            const data = Object.entries(sizeByDest).map(([label, bytes]) => {
                const destType = label.split('://')[0];
                return {
                    label: destType.toUpperCase(),
                    value: Math.round(bytes / (1024 * 1024 * 1024)) // Convert to GB
                };
            });

            if (data.length === 0) {
                data.push({ label: 'No data', value: 0 });
            }

            storageChart.setData(data);
        }

        function updateSizeTrendChart(metrics) {
            // Generate average backup size trend
            const data = [];
            const today = new Date();
            const avgSize = metrics.storage_stats.avg_backup_size || 0;
            const avgSizeGB = avgSize / (1024 * 1024 * 1024);

            for (let i = 29; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const label = (i === 0) ? 'Today' : (i === 1) ? 'Yesterday' : date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

                // Simulate variation around average
                const value = avgSizeGB + (Math.random() * 20 - 10);

                data.push({ label, value: Math.max(1, Math.round(value * 10) / 10) });
            }

            sizeTrendChart.setData(data);
        }

        // VM Chart Update Functions
        function updateVMSummaryStats(metrics) {
            const vms = metrics.virtual_machines || {};
            const resources = metrics.vm_resource_stats || {};

            document.getElementById('vm-total').textContent = vms.total || 0;
            document.getElementById('vm-running').textContent = vms.running || 0;
            document.getElementById('vm-total-cpus').textContent = resources.total_cpus || 0;
            document.getElementById('vm-total-memory').textContent = (resources.total_memory_gi || 0).toFixed(1);
            document.getElementById('vm-carbon-aware').textContent = resources.carbon_aware_vms || 0;
        }

        function updateVMTrendChart(metrics) {
            // Generate last 24 hours data (hourly)
            const data = [];
            const now = new Date();

            for (let i = 23; i >= 0; i--) {
                const hour = new Date(now);
                hour.setHours(hour.getHours() - i);
                const label = i === 0 ? 'Now' : `-${i}h`;

                // Simulate data (in production, fetch actual historical data)
                const vms = metrics.virtual_machines || {};
                const baseCount = vms.total || 0;
                const variation = Math.floor(Math.random() * 3) - 1;
                const value = Math.max(0, baseCount + variation);

                data.push({ label, value });
            }

            vmTrendChart.setData(data);
        }

        function updateVMStatusChart(metrics) {
            const vms = metrics.virtual_machines || {};
            const data = [
                { label: 'Running', value: vms.running || 0 },
                { label: 'Stopped', value: vms.stopped || 0 },
                { label: 'Creating', value: vms.creating || 0 },
                { label: 'Failed', value: vms.failed || 0 },
                { label: 'Migrating', value: vms.migrating || 0 }
            ].filter(d => d.value > 0);

            vmStatusChart.setData(data);
        }

        function updateVMNodeChart(metrics) {
            const vms = metrics.virtual_machines || {};
            const byNode = vms.by_node || {};

            const data = Object.entries(byNode)
                .map(([label, value]) => ({ label, value }))
                .sort((a, b) => b.value - a.value)
                .slice(0, 10);

            if (data.length === 0) {
                data.push({ label: 'No VMs', value: 0 });
            }

            vmNodeChart.setData(data);
        }

        function updateVMResourceChart(metrics) {
            // Show CPU and memory allocation over time
            const data = [];
            const resources = metrics.vm_resource_stats || {};

            for (let i = 23; i >= 0; i--) {
                const label = i === 0 ? 'Now' : `-${i}h`;
                // Simulate trend (in production, use actual historical data)
                const baseValue = (resources.total_cpus || 0) + (resources.total_memory_gi || 0) * 2;
                const variation = Math.floor(Math.random() * (baseValue * 0.1));
                const value = Math.max(0, baseValue + variation);

                data.push({ label, value });
            }

            vmResourceChart.setData(data);
        }

        function updateVMCarbonChart(metrics) {
            const data = [];
            const resources = metrics.vm_resource_stats || {};
            const avgIntensity = resources.avg_carbon_intensity || 0;

            for (let i = 23; i >= 0; i--) {
                const label = i === 0 ? 'Now' : `-${i}h`;
                // Simulate carbon intensity variation
                const variation = (Math.random() * 40) - 20;
                const value = Math.max(0, avgIntensity + variation);

                data.push({ label, value });
            }

            vmCarbonChart.setData(data);
        }

        function updateVMSizeChart(metrics) {
            const resources = metrics.vm_resource_stats || {};
            const vmsBySize = resources.vms_by_size || {};

            const data = [
                { label: 'Small (‚â§2 vCPUs)', value: vmsBySize.small || 0 },
                { label: 'Medium (3-8 vCPUs)', value: vmsBySize.medium || 0 },
                { label: 'Large (>8 vCPUs)', value: vmsBySize.large || 0 }
            ].filter(d => d.value > 0);

            if (data.length === 0) {
                data.push({ label: 'No VMs', value: 0 });
            }

            vmSizeChart.setData(data);
        }

        function formatBytesShort(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        function updateLastUpdateTime() {
            const now = new Date();
            document.getElementById('last-update').textContent =
                `Last updated: ${now.toLocaleTimeString()}`;
        }

        // Download chart as PNG image
        function downloadChart(canvasId, filename) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) {
                console.error('Canvas not found:', canvasId);
                return;
            }

            try {
                // Convert canvas to blob
                canvas.toBlob((blob) => {
                    if (!blob) {
                        console.error('Failed to create blob from canvas');
                        return;
                    }

                    // Create download link
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    const timestamp = new Date().toISOString().split('T')[0];
                    link.href = url;
                    link.download = `hypersdk-${filename}-${timestamp}.png`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                }, 'image/png');
            } catch (error) {
                console.error('Error downloading chart:', error);
                alert('Failed to download chart. Please try again.');
            }
        }
    </script>
</body>
</html>
