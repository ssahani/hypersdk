name: Publish Helm Chart

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Chart version to publish'
        required: true
        type: string

permissions:
  contents: write
  packages: write
  pages: write

jobs:
  publish-ghcr:
    name: Publish to GHCR
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Get version
        id: get_version
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
            VERSION="${VERSION#v}" # Remove 'v' prefix if present
          else
            VERSION="${{ inputs.version }}"
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Publishing version: ${VERSION}"

      - name: Update chart version
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          sed -i "s/^version:.*/version: ${VERSION}/" deployments/helm/hypersdk/Chart.yaml
          sed -i "s/^appVersion:.*/appVersion: ${VERSION}/" deployments/helm/hypersdk/Chart.yaml

      - name: Package Helm chart
        run: |
          helm package deployments/helm/hypersdk \
            --destination .deploy

      - name: Login to GHCR
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | \
            helm registry login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Push to GHCR
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          helm push .deploy/hypersdk-${VERSION}.tgz oci://ghcr.io/${{ github.repository_owner }}/charts

      - name: Logout from GHCR
        if: always()
        run: |
          helm registry logout ghcr.io

  publish-github-pages:
    name: Publish to GitHub Pages
    runs-on: ubuntu-latest
    needs: publish-ghcr
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout gh-pages branch
        run: |
          git fetch origin gh-pages || git checkout --orphan gh-pages
          git checkout gh-pages

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Get version
        id: get_version
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
            VERSION="${VERSION#v}"
          else
            VERSION="${{ inputs.version }}"
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: Checkout main branch files
        run: |
          git checkout main -- deployments/helm/hypersdk

      - name: Update chart version
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          sed -i "s/^version:.*/version: ${VERSION}/" deployments/helm/hypersdk/Chart.yaml
          sed -i "s/^appVersion:.*/appVersion: ${VERSION}/" deployments/helm/hypersdk/Chart.yaml

      - name: Package chart
        run: |
          mkdir -p helm-charts
          helm package deployments/helm/hypersdk -d helm-charts

      - name: Update Helm repository index
        run: |
          helm repo index helm-charts --url https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/helm-charts

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add helm-charts/
          git commit -m "Publish Helm chart version ${{ steps.get_version.outputs.version }}"
          git push origin gh-pages

  publish-dockerhub:
    name: Publish to Docker Hub (Optional)
    runs-on: ubuntu-latest
    if: github.repository_owner != ''
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Get version
        id: get_version
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
            VERSION="${VERSION#v}"
          else
            VERSION="${{ inputs.version }}"
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: Update chart version
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          sed -i "s/^version:.*/version: ${VERSION}/" deployments/helm/hypersdk/Chart.yaml
          sed -i "s/^appVersion:.*/appVersion: ${VERSION}/" deployments/helm/hypersdk/Chart.yaml

      - name: Package Helm chart
        run: |
          helm package deployments/helm/hypersdk --destination .deploy

      - name: Login to Docker Hub
        if: secrets.DOCKERHUB_USERNAME != ''
        run: |
          echo "${{ secrets.DOCKERHUB_TOKEN }}" | \
            helm registry login registry-1.docker.io -u ${{ secrets.DOCKERHUB_USERNAME }} --password-stdin

      - name: Push to Docker Hub
        if: secrets.DOCKERHUB_USERNAME != ''
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          helm push .deploy/hypersdk-${VERSION}.tgz oci://registry-1.docker.io/${{ secrets.DOCKERHUB_USERNAME }}

      - name: Logout from Docker Hub
        if: always() && secrets.DOCKERHUB_USERNAME != ''
        run: |
          helm registry logout registry-1.docker.io

  create-release-notes:
    name: Create Release Notes
    runs-on: ubuntu-latest
    needs: [publish-ghcr, publish-github-pages]
    if: github.event_name == 'release'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version
        id: get_version
        run: |
          VERSION="${{ github.event.release.tag_name }}"
          VERSION="${VERSION#v}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: Generate installation instructions
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          cat > release-notes.md <<EOF
          ## HyperSDK Helm Chart v${VERSION}

          ### Installation

          **From Helm Repository:**
          \`\`\`bash
          helm repo add hypersdk https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/helm-charts
          helm repo update
          helm install hypersdk hypersdk/hypersdk --version ${VERSION}
          \`\`\`

          **From OCI Registry (GHCR):**
          \`\`\`bash
          helm install hypersdk oci://ghcr.io/${{ github.repository_owner }}/charts/hypersdk --version ${VERSION}
          \`\`\`

          **From Docker Hub (if configured):**
          \`\`\`bash
          helm install hypersdk oci://registry-1.docker.io/${{ secrets.DOCKERHUB_USERNAME }}/hypersdk --version ${VERSION}
          \`\`\`

          ### Documentation

          - [Complete Documentation](https://github.com/${{ github.repository }}/tree/main/deployments/helm)
          - [Quick Start](https://github.com/${{ github.repository }}/blob/main/deployments/helm/README.md)
          - [Troubleshooting](https://github.com/${{ github.repository }}/blob/main/deployments/helm/TROUBLESHOOTING-FAQ.md)

          ### Changelog

          See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/deployments/helm/hypersdk/CHANGELOG.md)
          EOF

      - name: Update release notes
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const releaseNotes = fs.readFileSync('release-notes.md', 'utf8');
            const currentBody = context.payload.release.body || '';

            await github.rest.repos.updateRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: context.payload.release.id,
              body: releaseNotes + '\n\n' + currentBody
            });

  verify-publication:
    name: Verify Publication
    runs-on: ubuntu-latest
    needs: [publish-ghcr, publish-github-pages]
    steps:
      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Get version
        id: get_version
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
            VERSION="${VERSION#v}"
          else
            VERSION="${{ inputs.version }}"
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: Verify GHCR publication
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          sleep 30 # Wait for propagation
          helm pull oci://ghcr.io/${{ github.repository_owner }}/charts/hypersdk --version ${VERSION}
          echo "✓ Successfully pulled from GHCR"

      - name: Verify GitHub Pages publication
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          sleep 60 # Wait for GitHub Pages deployment
          helm repo add hypersdk-verify https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/helm-charts
          helm repo update
          helm search repo hypersdk-verify/hypersdk --version ${VERSION}
          echo "✓ Successfully found in GitHub Pages repository"
