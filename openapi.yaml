openapi: 3.0.3
info:
  title: HyperSDK API
  description: |
    VM migration and export platform providing unified VM export across 9 cloud/virtualization platforms.

    Supports: vSphere, AWS, Azure, GCP, Hyper-V, OCI, OpenStack, Alibaba Cloud, Proxmox
  version: 1.0.0
  contact:
    name: HyperSDK
    url: https://github.com/ssahani/hypersdk
  license:
    name: LGPL-3.0-or-later
    url: https://www.gnu.org/licenses/lgpl-3.0.html

servers:
  - url: http://localhost:8080
    description: Local development server
  - url: https://api.hypersdk.example.com
    description: Production server

security:
  - BearerAuth: []
  - ApiKeyAuth: []

tags:
  - name: Health
    description: Health check and status endpoints
  - name: Jobs
    description: Job submission, querying, and management
  - name: VMs
    description: Virtual machine discovery and operations
  - name: Schedules
    description: Scheduled job management
  - name: Webhooks
    description: Webhook configuration and testing
  - name: Authentication
    description: User authentication and session management
  - name: Libvirt
    description: Libvirt domain, volume, and network management
  - name: Console
    description: VM console access (VNC, serial)
  - name: Hyper2KVM
    description: Hyper2KVM integration and conversion
  - name: vSphere
    description: VMware vSphere infrastructure management

paths:
  /health:
    get:
      summary: Health check
      description: Check if the API server is healthy
      tags: [Health]
      security: []
      responses:
        '200':
          description: Server is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: healthy
                  timestamp:
                    type: string
                    format: date-time

  /status:
    get:
      summary: Get daemon status
      description: Get overall status of the daemon including job counts
      tags: [Health]
      responses:
        '200':
          description: Daemon status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DaemonStatus'

  /capabilities:
    get:
      summary: Get export capabilities
      description: Get available export methods and default method
      tags: [Health]
      responses:
        '200':
          description: Export capabilities
          content:
            application/json:
              schema:
                type: object
                properties:
                  capabilities:
                    type: object
                  default_method:
                    type: string
                  timestamp:
                    type: string
                    format: date-time

  /jobs/submit:
    post:
      summary: Submit job(s)
      description: Submit one or more VM export jobs
      tags: [Jobs]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              oneOf:
                - $ref: '#/components/schemas/JobDefinition'
                - type: array
                  items:
                    $ref: '#/components/schemas/JobDefinition'
                - $ref: '#/components/schemas/BatchJobDefinition'
          application/x-yaml:
            schema:
              oneOf:
                - $ref: '#/components/schemas/JobDefinition'
                - type: array
                  items:
                    $ref: '#/components/schemas/JobDefinition'
      responses:
        '200':
          description: Job(s) submitted successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SubmitResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /jobs/query:
    get:
      summary: Query jobs (GET)
      description: Query jobs with optional filters
      tags: [Jobs]
      parameters:
        - name: all
          in: query
          description: Return all jobs
          schema:
            type: boolean
      responses:
        '200':
          description: Jobs query result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/QueryResponse'
    post:
      summary: Query jobs (POST)
      description: Query jobs with detailed filters
      tags: [Jobs]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/QueryRequest'
      responses:
        '200':
          description: Jobs query result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/QueryResponse'

  /jobs/{jobId}:
    get:
      summary: Get specific job
      description: Get details of a specific job by ID
      tags: [Jobs]
      parameters:
        - name: jobId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Job details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Job'
        '404':
          description: Job not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /jobs/cancel:
    post:
      summary: Cancel jobs
      description: Cancel one or more running jobs
      tags: [Jobs]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CancelRequest'
      responses:
        '200':
          description: Cancel result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CancelResponse'

  /jobs/progress/{jobId}:
    get:
      summary: Get job progress
      description: Get real-time progress of a running job
      tags: [Jobs]
      parameters:
        - name: jobId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Job progress
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JobProgress'

  /jobs/logs/{jobId}:
    get:
      summary: Get job logs
      description: Get logs for a specific job
      tags: [Jobs]
      parameters:
        - name: jobId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Job logs
          content:
            text/plain:
              schema:
                type: string

  /jobs/eta/{jobId}:
    get:
      summary: Get job ETA
      description: Get estimated time of arrival for job completion
      tags: [Jobs]
      parameters:
        - name: jobId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Job ETA
          content:
            application/json:
              schema:
                type: object
                properties:
                  eta:
                    type: string
                  estimated_remaining:
                    type: string

  /vms/list:
    post:
      summary: List VMs
      description: List VMs from a provider
      tags: [VMs]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/VCenterConfig'
      responses:
        '200':
          description: List of VMs
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object

  /vms/info:
    post:
      summary: Get VM info
      description: Get detailed information about a specific VM
      tags: [VMs]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                vcenter:
                  $ref: '#/components/schemas/VCenterConfig'
                vm_path:
                  type: string
      responses:
        '200':
          description: VM information
          content:
            application/json:
              schema:
                type: object

  /vms/shutdown:
    post:
      summary: Shutdown VM
      description: Gracefully shutdown a VM
      tags: [VMs]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                vcenter:
                  $ref: '#/components/schemas/VCenterConfig'
                vm_path:
                  type: string
      responses:
        '200':
          description: Shutdown initiated
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string

  /schedules:
    get:
      summary: List schedules
      description: List all scheduled jobs
      tags: [Schedules]
      responses:
        '200':
          description: List of scheduled jobs
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ScheduledJob'
    post:
      summary: Create schedule
      description: Create a new scheduled job
      tags: [Schedules]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ScheduledJob'
      responses:
        '200':
          description: Schedule created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ScheduledJob'

  /schedules/{scheduleId}:
    get:
      summary: Get schedule
      description: Get details of a specific schedule
      tags: [Schedules]
      parameters:
        - name: scheduleId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Schedule details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ScheduledJob'
    put:
      summary: Update schedule
      description: Update an existing schedule
      tags: [Schedules]
      parameters:
        - name: scheduleId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ScheduledJob'
      responses:
        '200':
          description: Schedule updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ScheduledJob'
    delete:
      summary: Delete schedule
      description: Delete a scheduled job
      tags: [Schedules]
      parameters:
        - name: scheduleId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Schedule deleted
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string

  /schedules/{scheduleId}/enable:
    post:
      summary: Enable schedule
      description: Enable a disabled schedule
      tags: [Schedules]
      parameters:
        - name: scheduleId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Schedule enabled

  /schedules/{scheduleId}/disable:
    post:
      summary: Disable schedule
      description: Disable an active schedule
      tags: [Schedules]
      parameters:
        - name: scheduleId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Schedule disabled

  /schedules/{scheduleId}/trigger:
    post:
      summary: Trigger schedule
      description: Manually trigger a scheduled job
      tags: [Schedules]
      parameters:
        - name: scheduleId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Schedule triggered

  /webhooks:
    get:
      summary: List webhooks
      description: List all configured webhooks
      tags: [Webhooks]
      responses:
        '200':
          description: List of webhooks
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Webhook'
    post:
      summary: Add webhook
      description: Add a new webhook
      tags: [Webhooks]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Webhook'
      responses:
        '200':
          description: Webhook added

  /webhooks/test:
    post:
      summary: Test webhook
      description: Send a test event to a webhook URL
      tags: [Webhooks]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                url:
                  type: string
                  format: uri
      responses:
        '200':
          description: Webhook test successful

  /webhooks/{webhookId}:
    delete:
      summary: Delete webhook
      description: Remove a webhook
      tags: [Webhooks]
      parameters:
        - name: webhookId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Webhook deleted

  /api/login:
    post:
      summary: Login
      description: Authenticate and create a session
      tags: [Authentication]
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                username:
                  type: string
                password:
                  type: string
              required:
                - username
                - password
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  token:
                    type: string
                  expires_at:
                    type: string
                    format: date-time

  /api/logout:
    post:
      summary: Logout
      description: End the current session
      tags: [Authentication]
      responses:
        '200':
          description: Logout successful

  /libvirt/domains:
    get:
      summary: List libvirt domains
      description: List all libvirt VM domains
      tags: [Libvirt]
      responses:
        '200':
          description: List of domains
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object

  /libvirt/domain:
    get:
      summary: Get domain
      description: Get details of a specific domain
      tags: [Libvirt]
      parameters:
        - name: name
          in: query
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Domain details

  /libvirt/domain/start:
    post:
      summary: Start domain
      description: Start a libvirt domain
      tags: [Libvirt]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
      responses:
        '200':
          description: Domain started

  /libvirt/domain/shutdown:
    post:
      summary: Shutdown domain
      description: Gracefully shutdown a domain
      tags: [Libvirt]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
      responses:
        '200':
          description: Domain shutdown initiated

  /libvirt/snapshots:
    get:
      summary: List snapshots
      description: List all snapshots for a domain
      tags: [Libvirt]
      parameters:
        - name: domain
          in: query
          required: true
          schema:
            type: string
      responses:
        '200':
          description: List of snapshots

  /libvirt/snapshot/create:
    post:
      summary: Create snapshot
      description: Create a new snapshot of a domain
      tags: [Libvirt]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                domain:
                  type: string
                name:
                  type: string
                description:
                  type: string
      responses:
        '200':
          description: Snapshot created

  /convert/vm:
    post:
      summary: Convert VM
      description: Convert VM using hyper2kvm
      tags: [Hyper2KVM]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                source_path:
                  type: string
                output_path:
                  type: string
      responses:
        '200':
          description: Conversion started
          content:
            application/json:
              schema:
                type: object
                properties:
                  conversion_id:
                    type: string

  /convert/status:
    get:
      summary: Get conversion status
      description: Get status of a VM conversion
      tags: [Hyper2KVM]
      parameters:
        - name: conversion_id
          in: query
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Conversion status

  /ws:
    get:
      summary: WebSocket connection
      description: WebSocket endpoint for real-time updates
      tags: [Health]
      responses:
        '101':
          description: Switching Protocols to WebSocket

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      description: Session token obtained from /api/login
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key
      description: API key for authentication

  schemas:
    JobDefinition:
      type: object
      required:
        - vm_path
      properties:
        id:
          type: string
          description: Unique job identifier
        name:
          type: string
          description: Human-readable job name
        vm_path:
          type: string
          description: Path to the VM to export
          example: /Datacenter/vm/my-vm
        output_path:
          type: string
          description: Output path for exported files (CLI/YAML)
        output_dir:
          type: string
          description: Output directory for exported files (API)
        vcenter_url:
          type: string
          description: vCenter URL (CLI/YAML)
          example: vcenter.example.com
        vcenter:
          $ref: '#/components/schemas/VCenterConfig'
        username:
          type: string
          description: vCenter username
        datacenter:
          type: string
          description: Datacenter name
        format:
          type: string
          description: Export format
          enum: [qcow2, raw, vmdk, ova, ovf]
          default: ovf
        export_method:
          type: string
          description: Export method to use
          enum: [ctl, govc, ovftool, web, ""]
        method:
          type: string
          description: Alias for export_method (web API compatibility)
        compress:
          type: boolean
          description: Enable GZIP compression
          default: false
        thin:
          type: boolean
          description: Use thin provisioning
          default: false
        insecure:
          type: boolean
          description: Skip TLS certificate verification
          default: false
        options:
          $ref: '#/components/schemas/ExportOptions'
        created_at:
          type: string
          format: date-time

    ExportOptions:
      type: object
      properties:
        parallel_downloads:
          type: integer
          description: Number of parallel downloads
          default: 4
          minimum: 1
          maximum: 32
        remove_cdrom:
          type: boolean
          description: Remove CD-ROM devices before export
          default: false
        show_individual_progress:
          type: boolean
          description: Show progress for each file
          default: false
        enable_pipeline:
          type: boolean
          description: Enable hyper2kvm pipeline integration
        hyper2kvm_path:
          type: string
          description: Path to hyper2kvm executable
        pipeline_inspect:
          type: boolean
        pipeline_fix:
          type: boolean
        pipeline_convert:
          type: boolean
        pipeline_validate:
          type: boolean
        pipeline_compress:
          type: boolean
        compress_level:
          type: integer
          minimum: 1
          maximum: 9
        libvirt_integration:
          type: boolean
        libvirt_uri:
          type: string
        libvirt_autostart:
          type: boolean
        libvirt_bridge:
          type: string
        libvirt_pool:
          type: string

    VCenterConfig:
      type: object
      required:
        - server
        - username
        - password
      properties:
        server:
          type: string
          description: vCenter server address
          example: vcenter.example.com
        username:
          type: string
          description: vCenter username
          example: administrator@vsphere.local
        password:
          type: string
          format: password
          description: vCenter password
        insecure:
          type: boolean
          description: Skip TLS certificate verification
          default: false

    Job:
      type: object
      properties:
        definition:
          $ref: '#/components/schemas/JobDefinition'
        status:
          $ref: '#/components/schemas/JobStatus'
        progress:
          $ref: '#/components/schemas/JobProgress'
        result:
          $ref: '#/components/schemas/JobResult'
        error:
          type: string
        started_at:
          type: string
          format: date-time
        completed_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    JobStatus:
      type: string
      enum:
        - pending
        - running
        - completed
        - failed
        - cancelled

    JobProgress:
      type: object
      properties:
        phase:
          type: string
          description: Current phase
          enum: [connecting, discovering, exporting]
        current_file:
          type: string
        current_step:
          type: string
        files_downloaded:
          type: integer
        total_files:
          type: integer
        bytes_downloaded:
          type: integer
          format: int64
        bytes_transferred:
          type: integer
          format: int64
        total_bytes:
          type: integer
          format: int64
        percent_complete:
          type: number
          format: float
          minimum: 0
          maximum: 100
        estimated_remaining:
          type: string
        export_method:
          type: string

    JobResult:
      type: object
      properties:
        vm_name:
          type: string
        output_dir:
          type: string
        ovf_path:
          type: string
        files:
          type: array
          items:
            type: string
        output_files:
          type: array
          items:
            type: string
        total_size:
          type: integer
          format: int64
        duration:
          type: integer
          format: int64
          description: Duration in nanoseconds
        success:
          type: boolean
        export_method:
          type: string
        error:
          type: string

    BatchJobDefinition:
      type: object
      required:
        - jobs
      properties:
        jobs:
          type: array
          items:
            $ref: '#/components/schemas/JobDefinition'

    QueryRequest:
      type: object
      properties:
        job_ids:
          type: array
          items:
            type: string
        status:
          type: array
          items:
            $ref: '#/components/schemas/JobStatus'
        all:
          type: boolean
          description: Return all jobs
        limit:
          type: integer
          description: Limit number of results

    QueryResponse:
      type: object
      properties:
        jobs:
          type: array
          items:
            $ref: '#/components/schemas/Job'
        total:
          type: integer
        timestamp:
          type: string
          format: date-time

    SubmitResponse:
      type: object
      properties:
        job_ids:
          type: array
          items:
            type: string
        accepted:
          type: integer
        rejected:
          type: integer
        errors:
          type: array
          items:
            type: string
        timestamp:
          type: string
          format: date-time

    CancelRequest:
      type: object
      required:
        - job_ids
      properties:
        job_ids:
          type: array
          items:
            type: string

    CancelResponse:
      type: object
      properties:
        cancelled:
          type: array
          items:
            type: string
        failed:
          type: array
          items:
            type: string
        errors:
          type: object
          additionalProperties:
            type: string
        timestamp:
          type: string
          format: date-time

    DaemonStatus:
      type: object
      properties:
        version:
          type: string
        uptime:
          type: string
        total_jobs:
          type: integer
        running_jobs:
          type: integer
        completed_jobs:
          type: integer
        failed_jobs:
          type: integer
        cancelled_jobs:
          type: integer
        timestamp:
          type: string
          format: date-time

    ScheduledJob:
      type: object
      required:
        - name
        - schedule
        - job_template
      properties:
        id:
          type: string
        name:
          type: string
        description:
          type: string
        schedule:
          type: string
          description: Cron format schedule
          example: "0 2 * * *"
        job_template:
          $ref: '#/components/schemas/JobDefinition'
        enabled:
          type: boolean
          default: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        next_run:
          type: string
          format: date-time
        last_run:
          type: string
          format: date-time
        run_count:
          type: integer
        tags:
          type: array
          items:
            type: string

    Webhook:
      type: object
      required:
        - url
      properties:
        url:
          type: string
          format: uri
          description: Webhook URL to call
        events:
          type: array
          items:
            type: string
            enum: [job_started, job_completed, job_failed, job_cancelled]
          description: Events to trigger webhook
        headers:
          type: object
          additionalProperties:
            type: string
          description: Custom headers to include

    ErrorResponse:
      type: object
      properties:
        error:
          type: string
        timestamp:
          type: string
          format: date-time
